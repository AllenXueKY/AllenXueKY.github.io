<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>初识Java持久层框架Mybatis之下（连接池、缓存和注解开发） | Allen Xue&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Allen Xue&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Allen Xue&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Allen Xue</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 13, 2020&nbsp;&nbsp;23:13:27</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/Java-EE/">Java_EE</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><em>建议先看上篇文章（初识Java持久层框架Mybatis之上）<a href="https://blog.csdn.net/qq_34504626/article/details/104810222" target="_blank" rel="noopener">点击访问</a></em></p>
<h2 id="九、Mybatis连接池与事务深入"><a href="#九、Mybatis连接池与事务深入" class="headerlink" title="九、Mybatis连接池与事务深入"></a>九、Mybatis连接池与事务深入</h2><h3 id="1、Mybatis的连接池技术"><a href="#1、Mybatis的连接池技术" class="headerlink" title="1、Mybatis的连接池技术"></a>1、Mybatis的连接池技术</h3><ul>
<li><strong>在Mybatis中的连接池技术采用的是自己的连接池技术</strong>，<em>不像JDBC的连接池技术是使用其他厂商开发如：c3p0和druid</em>。</li>
<li><strong>在Mybatis的SqlMapConfig.xml配置文件中，通过<code>&lt;dataSource type=”POOLED”&gt;</code>来实现Mybatis中连接池的配置。</strong></li>
</ul>
<h4 id="（1）Mybatis连接池的分类"><a href="#（1）Mybatis连接池的分类" class="headerlink" title="（1）Mybatis连接池的分类"></a>（1）Mybatis连接池的分类</h4><ul>
<li><p><strong>在Mybatis中将它的数据源dataSource分为以下几类</strong>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/1.png" alt="image"></p>
</li>
<li><p>可以看出<strong>Mybatis将数据源分为三类</strong>：</p>
<pre><code>UNPOOLED 不使用连接池的数据源
POOLED 使用连接池的数据源
JNDI 使用JNDI实现的数据源</code></pre></li>
<li><p><strong>具体结构如下</strong>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/2.png" alt="image"></p>
</li>
<li><p>相应地，<strong>MyBatis内部分别定义了实现了<code>java.sql.DataSource</code>接口的<code>UnpooledDataSource</code>，<code>PooledDataSource</code>类来表示<code>UNPOOLED</code>、<code>POOLED</code>类型的数据源。</strong><br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/3.png" alt="image"></p>
</li>
<li><p>在这三种数据源中，<strong>我们一般采用的是POOLED数据源</strong>（<em>很多时候我们所说的数据源就是为了更好的管理数据<br>库连接，也就是我们所说的连接池技术</em>）。</p>
</li>
</ul>
<h4 id="（2）Mybatis中数据源的配置"><a href="#（2）Mybatis中数据源的配置" class="headerlink" title="（2）Mybatis中数据源的配置"></a>（2）Mybatis中数据源的配置</h4><p><strong>数据源配置在SqlMapConfig.xml文件中，具体配置如下</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 配置数据源（连接池）信息 --&gt;</span><br><span class="line">&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt;</span><br><span class="line">&lt;/dataSource&gt;</span><br></pre></td></tr></table></figure>

<p><strong>MyBatis在初始化时，根据<code>&lt;dataSource&gt;</code>的<code>type</code>属性来创建相应类型的的数据源DataSource</strong>，即：</p>
<ul>
<li><code>type=”POOLED”</code>：<strong>MyBatis会创建PooledDataSource实例</strong></li>
<li><code>type=”UNPOOLED”</code>：<strong>MyBatis会创建UnpooledDataSource实例</strong></li>
<li><code>type=”JNDI”</code><strong>：MyBatis会从JNDI服务上查找 DataSource实例，然后返回使用</strong><br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/12.png" alt="image"></li>
</ul>
<p>==<strong><em>以上都是重点，Mybatis的连接池只需要在SqlMapConfig.xml配置文件中进行上面的配置即可，下面是对其进行的分析</em></strong>==</p>
<h4 id="（3）Mybatis中DataSource的存取"><a href="#（3）Mybatis中DataSource的存取" class="headerlink" title="（3）Mybatis中DataSource的存取"></a>（3）Mybatis中DataSource的存取</h4><p><strong>MyBatis是通过工厂模式来创建数据源DataSource对象的， MyBatis定义了抽象的工厂接口:</strong><code>org.apache.ibatis.datasource.DataSourceFactory</code>,通过其 <code>getDataSource()</code>方法<strong>返回数据源DataSource</strong>。</p>
<ul>
<li><em>下面是DataSourceFactory源码，具体如下</em>：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.datasource;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">/**</span><br><span class="line">* @author Clinton Begin</span><br><span class="line">*/</span><br><span class="line">public interface DataSourceFactory &#123;</span><br><span class="line">    void setProperties(Properties props);</span><br><span class="line">    DataSource getDataSource();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>MyBatis创建了DataSource实例后，会将其放到Configuration对象内的Environment对象中，供以后使用。</strong></p>
<p>具体分析过程如下：</p>
<ul>
<li>先<strong>进入XMLConfigBuilder类中</strong>，可以找到如下代码：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/4.png" alt="image"></li>
<li>分析<strong>configuration对象的environment属性</strong>，结果如下：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/5.png" alt="image"></li>
</ul>
<h4 id="（4）Mybatis中连接的获取过程分析"><a href="#（4）Mybatis中连接的获取过程分析" class="headerlink" title="（4）Mybatis中连接的获取过程分析"></a>（4）Mybatis中连接的获取过程分析</h4><p><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/8.png" alt="image"><br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/7.png" alt="image"><br>当我们需要<strong>创建SqlSession对象并需要执行SQL语句时</strong>，这时候MyBatis才会去<strong>调用dataSource对象来创建<code>java.sql.Connection</code>对象</strong>。也就是说，<strong><code>java.sql.Connection</code>对象的创建一直延迟到执行SQL语句的时候。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testSql() throws Exception &#123;</span><br><span class="line">    InputStream in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">    SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in);</span><br><span class="line">    SqlSession sqlSession = factory.openSession();</span><br><span class="line">    List&lt;User&gt; list = sqlSession.selectList(&quot;findUserById&quot;,41);</span><br><span class="line">    System.out.println(list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有当第4句<code>sqlSession.selectList(&quot;findUserById&quot;)</code>，才会<strong>触发MyBatis在底层执行下面这个方<br>法来创建<code>java.sql.Connection</code>对象</strong>。</p>
<p><em>下面是连接获取的源代码</em>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/6.png" alt="image"></p>
<ul>
<li>最后我们可以发现，<strong>真正连接打开的时间点，只是在执行SQL语句时，才会进行</strong>。其实这样做也可以进一步发现，<strong>数据库连接是最为宝贵的资源，只有在要用到的时候，才去获取并打开连接，当用完了就再立即将数据库连接归还到连接池中</strong>。</li>
</ul>
<h3 id="2、Mybatis的事务控制"><a href="#2、Mybatis的事务控制" class="headerlink" title="2、Mybatis的事务控制"></a>2、Mybatis的事务控制</h3><h4 id="（1）JDBC中事务的回顾"><a href="#（1）JDBC中事务的回顾" class="headerlink" title="（1）JDBC中事务的回顾"></a>（1）JDBC中事务的回顾</h4><p><strong>在JDBC中我们可以通过手动方式将事务的提交改为手动方式，通过setAutoCommit()方法就可以调整。</strong></p>
<ul>
<li><em>通过JDK文档，我们找到该方法如下：</em><br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/9.png" alt="image"></li>
</ul>
<p><strong>Mybatis框架因为是对JDBC的封</strong>装，所以Mybatis框架的事务控制方式，<strong>本身也是用JDBC的setAutoCommit()方法来设置事务提交方式的。</strong></p>
<h4 id="（2）Mybatis中事务提交方式"><a href="#（2）Mybatis中事务提交方式" class="headerlink" title="（2）Mybatis中事务提交方式"></a>（2）Mybatis中事务提交方式</h4><p><strong>Mybatis中事务的提交方式，本质上就是调用JDBC的setAutoCommit()来实现事务控制。</strong></p>
<ul>
<li><p>运行如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public class MybatisTest &#123;</span><br><span class="line">    private InputStream in;</span><br><span class="line">    private SqlSession sqlSession;</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void init() throws IOException&#123;</span><br><span class="line">        //1、读取配置文件生成字节输入流</span><br><span class="line">        in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">        //2、获取SqlSessionFactory</span><br><span class="line">        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in);</span><br><span class="line">        //3、获取SqlSession对象</span><br><span class="line">        sqlSession = factory.openSession();</span><br><span class="line">        //4、获取dao的代理对象</span><br><span class="line">        userDao = sqlSession.getMapper(UserDao.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    public void destory() throws IOException &#123;</span><br><span class="line">        //提交事务</span><br><span class="line">        sqlSession.commit();</span><br><span class="line">        //6、释放资源</span><br><span class="line">        sqlSession.close();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 测试保存操作</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void testSave() throws IOException &#123;</span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setUsername(&quot;autocommit&quot;);</span><br><span class="line">        user.setAddress(&quot;陕西省西安市&quot;);</span><br><span class="line">        user.setSex(&quot;男&quot;);</span><br><span class="line">        user.setBirthday(new Date());</span><br><span class="line">        System.out.println(&quot;保存操作之前：&quot;+user);</span><br><span class="line">        //5、执行保存方法</span><br><span class="line">        userDao.saveUser(user);</span><br><span class="line">        System.out.println(&quot;保存操作之后：&quot;+user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/10.png" alt="image"></p>
</li>
</ul>
<p><strong>这是Connection的整个变化过程</strong>，通过分析我们能够发现之前的CUD操作过程中，我们都<strong>要手动进行事务的提交，原因是setAutoCommit()方法，在执行时它的值被设置为false了（默认为false）</strong>，所以我们在CUD操作中，<strong>必须通过<code>sqlSession.commit(true)</code>来执行提交操作。</strong></p>
<h4 id="（3）Mybatis自动提交事务的设置"><a href="#（3）Mybatis自动提交事务的设置" class="headerlink" title="（3）Mybatis自动提交事务的设置"></a>（3）Mybatis自动提交事务的设置</h4><p><strong>将<code>sqlSession.commit(true)</code>设置后就可以进行自动提交。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class MybatisTest &#123;</span><br><span class="line">    private InputStream in;</span><br><span class="line">    private SqlSession sqlSession;</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void init() throws IOException&#123;</span><br><span class="line">        //1、读取配置文件生成字节输入流</span><br><span class="line">        in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">        //2、获取SqlSessionFactory</span><br><span class="line">        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in);</span><br><span class="line">        //3、获取SqlSession对象</span><br><span class="line">        sqlSession = factory.openSession(true);</span><br><span class="line">        //4、获取dao的代理对象</span><br><span class="line">        userDao = sqlSession.getMapper(UserDao.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    public void destory() throws IOException &#123;</span><br><span class="line">        //6、释放资源</span><br><span class="line">        sqlSession.close();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 测试保存操作</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void testSave() throws IOException &#123;</span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setUsername(&quot;autocommit&quot;);</span><br><span class="line">        user.setAddress(&quot;陕西省西安市&quot;);</span><br><span class="line">        user.setSex(&quot;男&quot;);</span><br><span class="line">        user.setBirthday(new Date());</span><br><span class="line">        System.out.println(&quot;保存操作之前：&quot;+user);</span><br><span class="line">        //5、执行保存方法</span><br><span class="line">        userDao.saveUser(user);</span><br><span class="line">        System.out.println(&quot;保存操作之后：&quot;+user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时事务就设置为自动提交了，同样可以实现CUD操作时记录的保存。虽然这也是一种方式，但就编程而言，<strong>设置为自动提交方式为false再根据情况决定是否进行提交，这种方式更常用</strong>。因为我们可以根据业务情况来决定提交是否进行提交。</p>
<h2 id="十、Mybatis的动态SQL语句"><a href="#十、Mybatis的动态SQL语句" class="headerlink" title="十、Mybatis的动态SQL语句"></a>十、Mybatis的动态SQL语句</h2><ul>
<li>参考的<strong>官方文档</strong>，描述如下：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/11.png" alt="image"></li>
</ul>
<h3 id="1、动态SQL之-lt-if-gt-标签"><a href="#1、动态SQL之-lt-if-gt-标签" class="headerlink" title="1、动态SQL之&lt;if&gt;标签"></a>1、动态SQL之<code>&lt;if&gt;</code>标签</h3><p>我们根据实体类的不同取值，<strong>使用不同的SQL语句来进行查询</strong>。<em>比如在id如果不为空时可以根据id查询，如果username不同时为空，还要加入用户名作为条件。这种情况在我们的多条件组合查询中经常会碰到</em>。</p>
<h4 id="（1）持久层Dao接口"><a href="#（1）持久层Dao接口" class="headerlink" title="（1）持久层Dao接口"></a>（1）持久层Dao接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 查询所有用户</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">List&lt;User&gt; findAll();</span><br></pre></td></tr></table></figure>

<h4 id="（2）持久层Dao映射配置"><a href="#（2）持久层Dao映射配置" class="headerlink" title="（2）持久层Dao映射配置"></a>（2）持久层Dao映射配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findByUser&quot; resultType=&quot;user&quot; parameterType=&quot;user&quot;&gt;</span><br><span class="line">    select * from user where 1=1</span><br><span class="line">    &lt;if test=&quot;username!=null and username != &apos;&apos; &quot;&gt;</span><br><span class="line">        and username like #&#123;username&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;address != null&quot;&gt;</span><br><span class="line">        and address like #&#123;address&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p><strong>注意：<if>标签的test属性中写的是对象的属性名，如果是包装类的对象要使用OGNL表达式的写法。另外要注意 where 1=1 的作用~！</if></strong></p>
<h3 id="2、动态SQL之-lt-where-gt-标签"><a href="#2、动态SQL之-lt-where-gt-标签" class="headerlink" title="2、动态SQL之&lt;where&gt;标签"></a>2、动态SQL之<code>&lt;where&gt;</code>标签</h3><p><strong>为了简化上面<code>where 1=1</code>的条件拼装，我们可以采用<code>&lt;where&gt;</code>标签来简化开发。</strong></p>
<h4 id="持久层-Dao-映射配置"><a href="#持久层-Dao-映射配置" class="headerlink" title="持久层 Dao 映射配置"></a>持久层 Dao 映射配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--抽取重复的sql语句--&gt;</span><br><span class="line">&lt;sql id=&quot;defaultUser&quot;&gt;</span><br><span class="line">    select * from user</span><br><span class="line">&lt;/sql&gt;</span><br><span class="line">&lt;!-- 根据用户信息查询 --&gt;</span><br><span class="line">&lt;select id=&quot;findByUser&quot; resultType=&quot;user&quot; parameterType=&quot;user&quot;&gt;</span><br><span class="line">    &lt;include refid=&quot;defaultSql&quot;&gt;&lt;/include&gt;</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">        &lt;if test=&quot;username!=null and username != &apos;&apos; &quot;&gt;</span><br><span class="line">            and username like #&#123;username&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;address != null&quot;&gt;</span><br><span class="line">            and address like #&#123;address&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3、动态标签之-lt-foreach-gt-标签"><a href="#3、动态标签之-lt-foreach-gt-标签" class="headerlink" title="3、动态标签之&lt;foreach&gt;标签"></a>3、动态标签之<code>&lt;foreach&gt;</code>标签</h3><h4 id="（1）需求"><a href="#（1）需求" class="headerlink" title="（1）需求"></a>（1）需求</h4><p><strong>传入多个id查询用户信息</strong>，用下边两个sql实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM USERS WHERE username LIKE &apos;%张%&apos; AND (id =10 OR id =89 OR id=16)</span><br><span class="line">SELECT * FROM USERS WHERE username LIKE &apos;%张%&apos; AND id IN (10,89,16)</span><br></pre></td></tr></table></figure>

<p>这样我们在进行范围查询时，就要<strong>将一个集合中的值，作为参数动态添加进来。</strong></p>
<p><em>如何进行参数的传递？</em></p>
<ul>
<li><strong>在QueryVo中加入一个List集合用于封装参数</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 查询的条件</span><br><span class="line">*/</span><br><span class="line">public class QueryVo implements Serializable &#123;</span><br><span class="line">    private List&lt;Integer&gt; ids;</span><br><span class="line">    public List&lt;Integer&gt; getIds() &#123;</span><br><span class="line">        return ids;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setIds(List&lt;Integer&gt; ids) &#123;</span><br><span class="line">        this.ids = ids;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="（2）持久层Dao接口"><a href="#（2）持久层Dao接口" class="headerlink" title="（2）持久层Dao接口"></a>（2）持久层Dao接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 根据id集合查询用户</span><br><span class="line">* @param vo</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">List&lt;User&gt; findInIds(QueryVo vo);</span><br></pre></td></tr></table></figure>

<h4 id="（3）持久层Dao映射配置"><a href="#（3）持久层Dao映射配置" class="headerlink" title="（3）持久层Dao映射配置"></a>（3）持久层Dao映射配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 查询所有用户在 id 的集合之中 --&gt;</span><br><span class="line">&lt;select id=&quot;findInIds&quot; resultType=&quot;user&quot; parameterType=&quot;queryvo&quot;&gt;</span><br><span class="line">    &lt;!-- select * from user where id in (1,2,3,4,5); --&gt;</span><br><span class="line">    &lt;include refid=&quot;defaultSql&quot;&gt;&lt;/include&gt;</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">        &lt;if test=&quot;ids != null and ids.size() &gt; 0&quot;&gt;</span><br><span class="line">            &lt;foreach collection=&quot;ids&quot; open=&quot;id in ( &quot; close=&quot;)&quot; item=&quot;uid&quot;</span><br><span class="line">            separator=&quot;,&quot;&gt;</span><br><span class="line">                #&#123;uid&#125;</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>SQL语句：<code>select 字段 from user where id in (?)</code></li>
<li><strong><code>&lt;foreach&gt;</code>标签用于遍历集合</strong>，它的<strong>属性</strong>：<ul>
<li><code>collection</code>:<strong>代表要遍历的集合元素，注意编写时不要写<code>#{}</code></strong></li>
<li><code>open</code>:<strong>代表语句的开始部分</strong></li>
<li><code>close</code>:<strong>代表结束部分</strong></li>
<li><code>item</code>:<strong>代表遍历集合的每个元素，生成的变量名</strong></li>
<li><code>sperator</code>:<strong>代表分隔符</strong></li>
</ul>
</li>
</ul>
<h3 id="4、Mybatis中简化编写的SQL片段"><a href="#4、Mybatis中简化编写的SQL片段" class="headerlink" title="4、Mybatis中简化编写的SQL片段"></a>4、Mybatis中简化编写的SQL片段</h3><p><strong>Sql中可将重复的sql提取出来，使用时用include引用即可，最终达到sql重用的目的。（上面的例子中已经使用了）</strong></p>
<ul>
<li><p><strong>定义代码片段</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 抽取重复的语句代码片段 --&gt;</span><br><span class="line">&lt;sql id=&quot;defaultSql&quot;&gt;</span><br><span class="line">    select * from user</span><br><span class="line">&lt;/sql&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>引用代码片段</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 配置查询所有操作 --&gt;</span><br><span class="line">&lt;select id=&quot;findAll&quot; resultType=&quot;user&quot;&gt;</span><br><span class="line">    &lt;include refid=&quot;defaultSql&quot;&gt;&lt;/include&gt;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;!-- 根据 id 查询 --&gt;</span><br><span class="line">&lt;select id=&quot;findById&quot; resultType=&quot;UsEr&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">    &lt;include refid=&quot;defaultSql&quot;&gt;&lt;/include&gt;</span><br><span class="line">    where id = #&#123;uid&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="十一、Mybatis多表查询之一对多"><a href="#十一、Mybatis多表查询之一对多" class="headerlink" title="十一、Mybatis多表查询之一对多"></a>十一、Mybatis多表查询之一对多</h2><p><em>本次案例主要以最为简单的用户和账户的模型来分析Mybatis多表关系</em>。<strong>用户为Use表，账户为Account表。一个用户（User）可以有多个账户（Account）。具体关系如下</strong>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/13.png" alt="image"></p>
<h3 id="1、一对一查询-多对一"><a href="#1、一对一查询-多对一" class="headerlink" title="1、一对一查询(多对一)"></a>1、一对一查询(多对一)</h3><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p><strong>查询所有账户信息，关联查询下单用户信息。</strong></p>
<ul>
<li><strong>注意</strong>：因为<strong>一个账户信息只能供某个用户使用 **，所以</strong>从查询账户信息出发关联查询用户信息为一对一查询<strong>。如果</strong>从用户信息出发查询用户下的账户信息则为一对多查询，因为一个用户可以有多个账户**。</li>
</ul>
<h4 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h4><ul>
<li><p><strong>定义账户信息的实体类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Description: 账户的实体类</span><br><span class="line">*/</span><br><span class="line">public class Account implements Serializable &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private Integer uid;</span><br><span class="line">    private Double money;</span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getUid() &#123;</span><br><span class="line">        return uid;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUid(Integer uid) &#123;</span><br><span class="line">        this.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line">    public Double getMoney() &#123;</span><br><span class="line">        return money;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMoney(Double money) &#123;</span><br><span class="line">        this.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Account [id=&quot; + id + &quot;, uid=&quot; + uid + &quot;, money=&quot; + money + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写Sql语句</strong></p>
<ul>
<li><strong>实现查询账户信息时，也要查询账户所对应的用户信息。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT account.*,user.username,user.address FROM account, user WHERE account.uid = user.id</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>定义AccountUser类</strong></p>
<ul>
<li>为了能够封装上面SQL语句的查询结果，定义AccountCustomer类中<strong>要包含账户信息同时还要包含用户信息</strong>，所以我们要<strong>在定义AccountUser类时可以继承User类。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class AccountUser extends Account implements Serializable &#123;</span><br><span class="line">    private String username;</span><br><span class="line">    private String address;</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsername(String username) &#123;</span><br><span class="line">        this.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getAddress() &#123;</span><br><span class="line">        return address;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAddress(String address) &#123;</span><br><span class="line">        this.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return super.toString() + &quot; AccountUser [username=&quot; + username + &quot;,address=&quot; + address + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>定义账户的持久层Dao接口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 账户的持久层接口</span><br><span class="line">*/</span><br><span class="line">public interface AccountDao &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 查询所有账户，同时获取账户的所属用户名称以及它的地址信息</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    List&lt;AccountUser&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>定义AccountDao.xml文件中的查询配置信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.AccountDao&quot;&gt;</span><br><span class="line">    &lt;!-- 配置查询所有操作--&gt;</span><br><span class="line">    &lt;select id=&quot;findAll&quot; resultType=&quot;accountuser&quot;&gt;</span><br><span class="line">        select a.*,u.username,u.address from account a,user u where a.uid =u.id;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>注意</strong>：因为上面查询的结果中包含了账户信息同时还包含了用户信息，所以我们的返回值类型<strong>returnType的值设置为AccountUser类型，这样就可以接收账户信息和用户信息了。</strong></p>
<ul>
<li><strong>小结</strong>：</li>
<li><em>定义专门的po类作为输出类型，其中定义了sql查询结果集所有的字段。此方法较为简单，企业中使用普遍*</em></li>
</ul>
<h4 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h4><p><strong>使用resultMap，定义专门的resultMap用于映射一对一查询结果。</strong></p>
<ul>
<li><p><em>通过面向对象的(has a)关系可以得知，我们可以在Account 类中加入一个User类的对象来代表这个账户是哪个用户的。</em></p>
</li>
<li><p><strong>修改Account类</strong></p>
<ul>
<li><strong>在Account类中加入User类的对象作为Account类的一个属性。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 账户的实体类</span><br><span class="line">*/</span><br><span class="line">public class Account implements Serializable &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private Integer uid;</span><br><span class="line">    private Double money;</span><br><span class="line">    private User user;</span><br><span class="line">    public User getUser() &#123;</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUser(User user) &#123;</span><br><span class="line">        this.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getUid() &#123;</span><br><span class="line">        return uid;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUid(Integer uid) &#123;</span><br><span class="line">        this.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line">    public Double getMoney() &#123;</span><br><span class="line">        return money;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setMoney(Double money) &#123;</span><br><span class="line">        this.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Account [id=&quot; + id + &quot;, uid=&quot; + uid + &quot;, money=&quot; + money + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>修改AccountDao接口中的方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 账户的持久层接口</span><br><span class="line">*/</span><br><span class="line">public interface AccountDao &#123;</span><br><span class="line">    /**</span><br><span class="line">    * 查询所有账户，同时获取账户的所属用户名称以及它的地址信息</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    List&lt;Account&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意</strong>：<strong>第二种方式，将返回值改为Account类型。因为Account类中包含了一个User类的对象，它可以封装账户所对应的用户信息</strong>。</p>
</li>
<li><p><strong>重新定义AccountDao.xml文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.AccountDao&quot;&gt;</span><br><span class="line">    &lt;!-- 建立对应关系 --&gt;</span><br><span class="line">    &lt;resultMap type=&quot;account&quot; id=&quot;accountMap&quot;&gt;</span><br><span class="line">        &lt;id column=&quot;aid&quot; property=&quot;id&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;uid&quot; property=&quot;uid&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;money&quot; property=&quot;money&quot;/&gt;</span><br><span class="line">        &lt;!-- 它是用于指定从表方的引用实体属性的 --&gt;</span><br><span class="line">        &lt;association property=&quot;user&quot; javaType=&quot;user&quot;&gt;</span><br><span class="line">            &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</span><br><span class="line">        &lt;/association&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;select id=&quot;findAll&quot; resultMap=&quot;accountMap&quot;&gt;</span><br><span class="line">        select u.*,a.id as aid,a.uid,a.money from account a,user u where a.uid =u.id;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="2、一对多查询"><a href="#2、一对多查询" class="headerlink" title="2、一对多查询"></a>2、一对多查询</h3><h4 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h4><p><strong>查询所有用户信息及用户关联的账户信息。</strong></p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p><strong>用户信息和他的账户信息为一对多关系</strong>，并且查询过程中如果用户没有账户信息，此时也要将用户信息查询出来，我们想到了<strong>左外连接查询比较合适</strong>。</p>
<h4 id="（1）编写SQL语句"><a href="#（1）编写SQL语句" class="headerlink" title="（1）编写SQL语句"></a>（1）编写SQL语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT u.*, acc.id id,acc.uid,acc.money FROM user u</span><br><span class="line">LEFT JOIN account acc ON u.id = acc.uid;</span><br></pre></td></tr></table></figure>

<h4 id="（2）User类加入List-lt-Account-gt"><a href="#（2）User类加入List-lt-Account-gt" class="headerlink" title="（2）User类加入List&lt;Account&gt;"></a>（2）User类加入<code>List&lt;Account&gt;</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Description: 用户的实体类</span><br><span class="line">*/</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String username;</span><br><span class="line">    private Date birthday;</span><br><span class="line">    private String sex;</span><br><span class="line">    private String address;</span><br><span class="line">    private List&lt;Account&gt; accounts;</span><br><span class="line">    public List&lt;Account&gt; getAccounts() &#123;</span><br><span class="line">        return accounts;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAccounts(List&lt;Account&gt; accounts) &#123;</span><br><span class="line">        this.accounts = accounts;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsername(String username) &#123;</span><br><span class="line">        this.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    public Date getBirthday() &#123;</span><br><span class="line">        return birthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setBirthday(Date birthday) &#123;</span><br><span class="line">        this.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getSex() &#123;</span><br><span class="line">        return sex;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setSex(String sex) &#123;</span><br><span class="line">        this.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getAddress() &#123;</span><br><span class="line">        return address;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAddress(String address) &#123;</span><br><span class="line">        this.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;User [id=&quot; + id + &quot;, username=&quot; + username + &quot;, birthday=&quot; + birthday + &quot;,sex=&quot; + sex + &quot;, address=&quot; + address + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（3）用户持久层Dao接口中加入查询方法"><a href="#（3）用户持久层Dao接口中加入查询方法" class="headerlink" title="（3）用户持久层Dao接口中加入查询方法"></a>（3）用户持久层Dao接口中加入查询方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 查询所有用户，同时获取出每个用户下的所有账户信息</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">List&lt;User&gt; findAll();</span><br></pre></td></tr></table></figure>

<h4 id="（4）用户持久层Dao映射文件配置"><a href="#（4）用户持久层Dao映射文件配置" class="headerlink" title="（4）用户持久层Dao映射文件配置"></a>（4）用户持久层Dao映射文件配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.UserDao&quot;&gt;</span><br><span class="line">    &lt;resultMap type=&quot;user&quot; id=&quot;userMap&quot;&gt;</span><br><span class="line">        &lt;id column=&quot;id&quot; property=&quot;id&quot;&gt;&lt;/id&gt;</span><br><span class="line">        &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</span><br><span class="line">        &lt;!-- collection 是用于建立一对多中集合属性的对应关系</span><br><span class="line">        ofType 用于指定集合元素的数据类型</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;collection property=&quot;accounts&quot; ofType=&quot;account&quot;&gt;</span><br><span class="line">            &lt;id column=&quot;aid&quot; property=&quot;id&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;uid&quot; property=&quot;uid&quot;/&gt;</span><br><span class="line">            &lt;result column=&quot;money&quot; property=&quot;money&quot;/&gt;</span><br><span class="line">        &lt;/collection&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;!-- 配置查询所有操作 --&gt;</span><br><span class="line">    &lt;select id=&quot;findAll&quot; resultMap=&quot;userMap&quot;&gt;</span><br><span class="line">        select u.*,a.id as aid ,a.uid,a.money from user u left outer join account a on u.id =a.uid</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>collection</code>部分定义了用户关联的账户信息。表示关联查询结果集</strong></li>
<li><strong><code>property=&quot;accList&quot;</code>：关联查询的结果集存储在 User 对象的上哪个属性。</strong></li>
<li><strong><code>ofType=&quot;account&quot;</code>：指定关联查询的结果集中的对象类型即List中的对象类型。此处可以使用别名，也可以使用全限定名。</strong></li>
</ul>
<h2 id="十二、Mybatis多表查询之多对多"><a href="#十二、Mybatis多表查询之多对多" class="headerlink" title="十二、Mybatis多表查询之多对多"></a>十二、Mybatis多表查询之多对多</h2><h3 id="1、实现Role到User多对多"><a href="#1、实现Role到User多对多" class="headerlink" title="1、实现Role到User多对多"></a>1、实现Role到User多对多</h3><p><strong>多对多关系其实可以看成是双向的一对多关系。</strong></p>
<h4 id="（1）用户与角色的关系模型"><a href="#（1）用户与角色的关系模型" class="headerlink" title="（1）用户与角色的关系模型"></a>（1）用户与角色的关系模型</h4><p>用户与角色的多对多关系模型如下：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/14.png" alt="image"></p>
<p><strong>在MySQL数据库中添加角色表，用户角色的中间表。</strong></p>
<ul>
<li>角色表<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/15.png" alt="image"></li>
<li>用户角色中间表<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/16.png" alt="image"></li>
</ul>
<h4 id="（2）业务要求及实现SQL"><a href="#（2）业务要求及实现SQL" class="headerlink" title="（2）业务要求及实现SQL"></a>（2）业务要求及实现SQL</h4><ul>
<li><strong>需求：实现查询所有对象并且加载它所分配的用户信息。</strong></li>
<li><strong>分析：</strong><ul>
<li>查询角色我们需要用到Role表，但角色分配的用户的信息我们并不能直接找到用户信息，而是要<strong>通过中间表(USER_ROLE 表)才能关联到用户信息</strong>。</li>
</ul>
</li>
<li>下面是实现的SQL语句：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT r.*,u.id uid,u.username username,u.birthday birthday,u.sex sex,u.address address FROM ROLE r</span><br><span class="line">INNER JOIN USER_ROLE ur ON ( r.id = ur.rid)</span><br><span class="line">INNER JOIN USER u ON (ur.uid = u.id);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="（3）编写角色实体类"><a href="#（3）编写角色实体类" class="headerlink" title="（3）编写角色实体类"></a>（3）编写角色实体类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public class Role implements Serializable &#123;</span><br><span class="line">    private Integer roleId;</span><br><span class="line">    private String roleName;</span><br><span class="line">    private String roleDesc;</span><br><span class="line">    //多对多的关系映射：一个角色可以赋予多个用户</span><br><span class="line">    private List&lt;User&gt; users;</span><br><span class="line">    public List&lt;User&gt; getUsers() &#123;</span><br><span class="line">        return users;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsers(List&lt;User&gt; users) &#123;</span><br><span class="line">        this.users = users;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getRoleId() &#123;</span><br><span class="line">        return roleId;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setRoleId(Integer roleId) &#123;</span><br><span class="line">        this.roleId = roleId;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getRoleName() &#123;</span><br><span class="line">        return roleName;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setRoleName(String roleName) &#123;</span><br><span class="line">        this.roleName = roleName;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getRoleDesc() &#123;</span><br><span class="line">        return roleDesc;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setRoleDesc(String roleDesc) &#123;</span><br><span class="line">        this.roleDesc = roleDesc;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Role&#123;&quot; + &quot;roleId=&quot; + roleId + &quot;, roleName=&apos;&quot; + roleName + &apos;\&apos;&apos; + &quot;, roleDesc=&apos;&quot; + roleDesc + &apos;\&apos;&apos; + &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）编写Role持久层接口"><a href="#（4）编写Role持久层接口" class="headerlink" title="（4）编写Role持久层接口"></a>（4）编写Role持久层接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public interface RoleDao &#123;</span><br><span class="line"> /**</span><br><span class="line"> * 查询所有角色</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line"> List&lt;Role&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（5）编写映射文件"><a href="#（5）编写映射文件" class="headerlink" title="（5）编写映射文件"></a>（5）编写映射文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.RoleDao&quot;&gt;</span><br><span class="line">     &lt;!--定义 role 表的 ResultMap--&gt;</span><br><span class="line">     &lt;resultMap id=&quot;roleMap&quot; type=&quot;role&quot;&gt;</span><br><span class="line">         &lt;id property=&quot;roleId&quot; column=&quot;rid&quot;&gt;&lt;/id&gt;</span><br><span class="line">         &lt;result property=&quot;roleName&quot; column=&quot;role_name&quot;&gt;&lt;/result&gt;</span><br><span class="line">         &lt;result property=&quot;roleDesc&quot; column=&quot;role_desc&quot;&gt;&lt;/result&gt;</span><br><span class="line">         &lt;collection property=&quot;users&quot; ofType=&quot;user&quot;&gt;</span><br><span class="line">             &lt;id column=&quot;id&quot; property=&quot;id&quot;&gt;&lt;/id&gt;</span><br><span class="line">             &lt;result column=&quot;username&quot; property=&quot;username&quot;&gt;&lt;/result&gt;</span><br><span class="line">             &lt;result column=&quot;address&quot; property=&quot;address&quot;&gt;&lt;/result&gt;</span><br><span class="line">             &lt;result column=&quot;sex&quot; property=&quot;sex&quot;&gt;&lt;/result&gt;</span><br><span class="line">             &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;&gt;&lt;/result&gt;</span><br><span class="line">         &lt;/collection&gt;</span><br><span class="line">     &lt;/resultMap&gt;</span><br><span class="line">     &lt;!--查询所有--&gt;</span><br><span class="line">     &lt;select id=&quot;findAll&quot; resultMap=&quot;roleMap&quot;&gt;</span><br><span class="line">        select u.*,r.id as rid,r.role_name,r.role_desc from role r left outer join user_role ur on r.id = ur.rid left outer join user u on u.id = ur.uid </span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2、实现User到Role的多对多"><a href="#2、实现User到Role的多对多" class="headerlink" title="2、实现User到Role的多对多"></a>2、实现User到Role的多对多</h3><p>从User出发，我们也可以发现<strong>一个用户可以具有多个角色</strong>，这样用户到角色的关系也还是<strong>一对多关系</strong>。这样我们就可以认为<strong>User与Role的多对多关系，可以被拆解成两个一对多关系来实现。</strong> <em>实现过程和Role到User的多对多实现过程类似，这里不在赘述</em></p>
<h2 id="十三、Mybatis延迟加载策略"><a href="#十三、Mybatis延迟加载策略" class="headerlink" title="十三、Mybatis延迟加载策略"></a>十三、Mybatis延迟加载策略</h2><p><strong>实际开发过程中很多时候我们并不需要总是在加载用户信息时就一定要加载他的账户信息。此时就是我们所说的延迟加载。</strong></p>
<h3 id="1、何为延迟加载"><a href="#1、何为延迟加载" class="headerlink" title="1、何为延迟加载?"></a>1、何为延迟加载?</h3><ul>
<li><strong>延迟加载</strong>：<strong>就是在需要用到数据时才进行加载，不需要用到数据时就不加载数据。延迟加载也称懒加载.</strong></li>
<li><strong>好处</strong>：先从单表查询，需要时再从关联表去关联查询，<strong>大大提高数据库性能，因为查询单表要比关联查询多张表速度要快</strong>。</li>
<li><strong>坏处</strong>：因为只有当需要用到数据时，才会进行数据库查询，这样在大批量数据查询时，因为查询工作也要消耗时间，所以可能造成用户等待时间变长，造成用户体验下降。</li>
</ul>
<h3 id="2、实现需求"><a href="#2、实现需求" class="headerlink" title="2、实现需求"></a>2、实现需求</h3><ul>
<li><em>需求：查询账户(Account)信息并且关联查询用户(User)信息。如果先查询账户(Account)信息即可满足要求，当我们需要查询用户(User)信息时再查询用户(User)信息。把对用户(User)信息的按需去查询就是延迟加载。</em></li>
<li>mybatis实现多表操作时，使用了resultMap来实现一对一，一对多，多对多关系的操作。主要是通过 association、collection实现一对一及一对多映射。<strong>association、collection 具备延迟加载功能。</strong></li>
</ul>
<h3 id="3、使用assocation实现延迟加载"><a href="#3、使用assocation实现延迟加载" class="headerlink" title="3、使用assocation实现延迟加载"></a>3、使用assocation实现延迟加载</h3><h4 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h4><p><strong>查询账户信息同时查询用户信息。</strong></p>
<h4 id="（1）账户的持久层DAO接口"><a href="#（1）账户的持久层DAO接口" class="headerlink" title="（1）账户的持久层DAO接口"></a>（1）账户的持久层DAO接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 账户的持久层接口</span><br><span class="line">*/</span><br><span class="line">public interface AccountDao &#123;</span><br><span class="line">    /**</span><br><span class="line">    * 查询所有账户，同时获取账户的所属用户名称以及它的地址信息</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    List&lt;Account&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（2）账户的持久层映射文件"><a href="#（2）账户的持久层映射文件" class="headerlink" title="（2）账户的持久层映射文件"></a>（2）账户的持久层映射文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.AccountDao&quot;&gt;</span><br><span class="line">    &lt;!-- 建立对应关系 --&gt;</span><br><span class="line">    &lt;resultMap type=&quot;account&quot; id=&quot;accountMap&quot;&gt;</span><br><span class="line">        &lt;id column=&quot;aid&quot; property=&quot;id&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;uid&quot; property=&quot;uid&quot;/&gt;</span><br><span class="line">        &lt;result column=&quot;money&quot; property=&quot;money&quot;/&gt;</span><br><span class="line">        &lt;!-- 它是用于指定从表方的引用实体属性的 --&gt;</span><br><span class="line">        &lt;association property=&quot;user&quot; javaType=&quot;user&quot; select=&quot;com.allen.dao.UserDao.findById&quot; column=&quot;uid&quot;&gt;</span><br><span class="line">        &lt;/association&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;select id=&quot;findAll&quot; resultMap=&quot;accountMap&quot;&gt;</span><br><span class="line">        select * from account</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>select</code>：填写我们要调用的select映射的id</strong></li>
<li><strong><code>column</code>：填写我们要传递给select映射的参数</strong></li>
</ul>
<h4 id="（3）用户的持久层接口和映射文件"><a href="#（3）用户的持久层接口和映射文件" class="headerlink" title="（3）用户的持久层接口和映射文件"></a>（3）用户的持久层接口和映射文件</h4><ul>
<li><p>持久层接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 用户的业务层接口</span><br><span class="line">*/</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">/**</span><br><span class="line">* 根据 id 查询</span><br><span class="line">* @param userId</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">User findById(Integer userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>映射文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.UserDao&quot;&gt;</span><br><span class="line">&lt;!-- 根据 id 查询 --&gt;</span><br><span class="line">&lt;select id=&quot;findById&quot; resultType=&quot;user&quot; parameterType=&quot;int&quot; &gt;</span><br><span class="line">select * from user where id = #&#123;uid&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="（4）开启Mybatis的延迟加载策略"><a href="#（4）开启Mybatis的延迟加载策略" class="headerlink" title="（4）开启Mybatis的延迟加载策略"></a>（4）开启Mybatis的延迟加载策略</h4><p><em>Mybaits的官方文档，settings的说明信息如下</em>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/17.png" alt="image"></p>
<p><strong>在Mybatis的配置文件SqlMapConfig.xml文件中添加延迟加载的配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 开启延迟加载的支持 --&gt;</span><br><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;setting name=&quot;aggressiveLazyLoading&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>

<h4 id="（5）编写测试只查账户信息不查用户信息"><a href="#（5）编写测试只查账户信息不查用户信息" class="headerlink" title="（5）编写测试只查账户信息不查用户信息"></a>（5）编写测试只查账户信息不查用户信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 一对多账户的操作</span><br><span class="line">*/</span><br><span class="line">public class AccountTest &#123;</span><br><span class="line">    private InputStream in ;</span><br><span class="line">    private SqlSessionFactory factory;</span><br><span class="line">    private SqlSession session;</span><br><span class="line">    private AccountDao accountDao;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindAll() &#123;</span><br><span class="line">        //6.执行操作</span><br><span class="line">        List&lt;Account&gt; accounts = accountDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    @Before//在测试方法执行之前执行</span><br><span class="line">    public void init()throws Exception &#123;</span><br><span class="line">        //1.读取配置文件</span><br><span class="line">        in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">        //2.创建构建者对象</span><br><span class="line">        SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();</span><br><span class="line">        //3.创建 SqlSession 工厂对象</span><br><span class="line">        factory = builder.build(in);</span><br><span class="line">        //4.创建 SqlSession 对象</span><br><span class="line">        session = factory.openSession();</span><br><span class="line">        //5.创建 Dao 的代理对象</span><br><span class="line">        accountDao = session.getMapper(AccountDao.class);</span><br><span class="line">    &#125;</span><br><span class="line">    @After//在测试方法执行完成之后执行</span><br><span class="line">    public void destroy() throws Exception&#123;</span><br><span class="line">        //7.释放资源</span><br><span class="line">        session.close();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果如下</strong>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/18.png" alt="image"></p>
<ul>
<li>因为本次只是将Account对象查询出来放入List集合中，并没有涉及到User对象，所以就<strong>没有发出SQL语句查询账户所关联的User对象的查询</strong>。</li>
</ul>
<h3 id="4、使用Collection实现延迟加载"><a href="#4、使用Collection实现延迟加载" class="headerlink" title="4、使用Collection实现延迟加载"></a>4、使用Collection实现延迟加载</h3><p><strong><code>&lt;collection&gt;</code>结点中也有<code>select</code>属性，<code>column</code>属性。</strong></p>
<h4 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h4><p><strong>完成加载用户对象时，查询该用户所拥有的账户信息。</strong></p>
<h4 id="（1）在User实体类中加入List-lt-Account-gt-属性"><a href="#（1）在User实体类中加入List-lt-Account-gt-属性" class="headerlink" title="（1）在User实体类中加入List&lt;Account&gt;属性"></a>（1）在User实体类中加入<code>List&lt;Account&gt;</code>属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 用户的实体类</span><br><span class="line">*/</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String username;</span><br><span class="line">    private Date birthday;</span><br><span class="line">    private String sex;</span><br><span class="line">    private String address;</span><br><span class="line">    private List&lt;Account&gt; accounts;</span><br><span class="line">    public List&lt;Account&gt; getAccounts() &#123;</span><br><span class="line">        return accounts;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAccounts(List&lt;Account&gt; accounts) &#123;</span><br><span class="line">        this.accounts = accounts;</span><br><span class="line">    &#125;</span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUsername(String username) &#123;</span><br><span class="line">        this.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    public Date getBirthday() &#123;</span><br><span class="line">        return birthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setBirthday(Date birthday) &#123;</span><br><span class="line">        this.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getSex() &#123;</span><br><span class="line">        return sex;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setSex(String sex) &#123;</span><br><span class="line">        this.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getAddress() &#123;</span><br><span class="line">        return address;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAddress(String address) &#123;</span><br><span class="line">        this.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;User [id=&quot; + id + &quot;, username=&quot; + username + &quot;, birthday=&quot; + birthday  + &quot;, sex=&quot; + sex + &quot;, address=&quot; + address + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（2）编写用户和账户持久层接口的方法"><a href="#（2）编写用户和账户持久层接口的方法" class="headerlink" title="（2）编写用户和账户持久层接口的方法"></a>（2）编写用户和账户持久层接口的方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 查询所有用户，同时获取出每个用户下的所有账户信息</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">List&lt;User&gt; findAll();</span><br><span class="line">/**</span><br><span class="line">* 根据用户 id 查询账户信息</span><br><span class="line">* @param uid</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">List&lt;Account&gt; findByUid(Integer uid);</span><br></pre></td></tr></table></figure>

<h4 id="（3）编写用户持久层映射配置"><a href="#（3）编写用户持久层映射配置" class="headerlink" title="（3）编写用户持久层映射配置"></a>（3）编写用户持久层映射配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;user&quot; id=&quot;userMap&quot;&gt;</span><br><span class="line">    &lt;id column=&quot;id&quot; property=&quot;id&quot;&gt;&lt;/id&gt;</span><br><span class="line">    &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</span><br><span class="line">    &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</span><br><span class="line">    &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</span><br><span class="line">    &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</span><br><span class="line">    &lt;!-- collection 是用于建立一对多中集合属性的对应关系</span><br><span class="line">    ofType 用于指定集合元素的数据类型</span><br><span class="line">    select 是用于指定查询账户的唯一标识（账户的 dao 全限定类名加上方法名称）</span><br><span class="line">    column 是用于指定使用哪个字段的值作为条件查询</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;collection property=&quot;accounts&quot; ofType=&quot;account&quot; select=&quot;com.allen.dao.AccountDao.findByUid&quot; column=&quot;id&quot;&gt;&lt;/collection&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line">&lt;!-- 配置查询所有操作 --&gt;</span><br><span class="line">&lt;select id=&quot;findAll&quot; resultMap=&quot;userMap&quot;&gt;</span><br><span class="line">    select * from user</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>&lt;collection&gt;</code>标签： 主要用于加载关联的集合对象</strong></li>
<li><strong><code>select</code>属性：用于指定查询account列表的sql语句，所以填写的是该sql映射的id</strong></li>
<li><strong><code>column</code>属性：用于指定select属性的sql语句的参数来源，上面的参数来自于user的id列，所以就写成id这一个字段名了</strong></li>
</ul>
<h4 id="（4）编写账户持久层映射配置"><a href="#（4）编写账户持久层映射配置" class="headerlink" title="（4）编写账户持久层映射配置"></a>（4）编写账户持久层映射配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 根据用户 id 查询账户信息 --&gt;</span><br><span class="line">&lt;select id=&quot;findByUid&quot; resultType=&quot;account&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">    select * from account where uid = #&#123;uid&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h4 id="（5）测试只加载用户信息"><a href="#（5）测试只加载用户信息" class="headerlink" title="（5）测试只加载用户信息"></a>（5）测试只加载用户信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 一对多的操作</span><br><span class="line">*/</span><br><span class="line">public class UserTest &#123;</span><br><span class="line">    private InputStream in ;</span><br><span class="line">    private SqlSessionFactory factory;</span><br><span class="line">    private SqlSession session;</span><br><span class="line">    private UserDao userDao;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindAll() &#123;</span><br><span class="line">        //6.执行操作</span><br><span class="line">        List&lt;User&gt; users = userDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    @Before//在测试方法执行之前执行</span><br><span class="line">    public void init()throws Exception &#123;</span><br><span class="line">        //1.读取配置文件</span><br><span class="line">        in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">        //2.创建构建者对象</span><br><span class="line">        SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();</span><br><span class="line">        //3.创建 SqlSession 工厂对象</span><br><span class="line">        factory = builder.build(in);</span><br><span class="line">        //4.创建 SqlSession 对象</span><br><span class="line">        session = factory.openSession();</span><br><span class="line">        //5.创建 Dao 的代理对象</span><br><span class="line">        userDao = session.getMapper(UserDao.class);</span><br><span class="line">    &#125;</span><br><span class="line">    @After//在测试方法执行完成之后执行</span><br><span class="line">    public void destroy() throws Exception&#123;</span><br><span class="line">         </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果如下</strong>：<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/19.png" alt="image"></p>
<ul>
<li><strong>没有加载 Account 账户信息</strong>。</li>
</ul>
<h2 id="十四、Mybatis缓存"><a href="#十四、Mybatis缓存" class="headerlink" title="十四、Mybatis缓存"></a>十四、Mybatis缓存</h2><p>像大多数的持久化框架一样<strong>，Mybatis也提供了缓存策略，通过缓存策略来减少数据库的查询次数，从而提高性能。</strong></p>
<ul>
<li>Mybatis中缓存分为<strong>一级缓存，二级缓存</strong>。<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/20.png" alt="image"></li>
</ul>
<h3 id="1、Mybatis一级缓存"><a href="#1、Mybatis一级缓存" class="headerlink" title="1、Mybatis一级缓存"></a>1、Mybatis一级缓存</h3><h4 id="（1）证明一级缓存的存在"><a href="#（1）证明一级缓存的存在" class="headerlink" title="（1）证明一级缓存的存在"></a>（1）证明一级缓存的存在</h4><p>一级缓存是 SqlSession 级别的缓存，只要 SqlSession 没有 flush 或 close，它就存在。</p>
<ul>
<li><p><strong>编写用户持久层Dao接口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 用户的业务层接口&lt;/p&gt;</span><br><span class="line">*/</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">/**</span><br><span class="line">* 根据 id 查询</span><br><span class="line">* @param userId</span><br><span class="line">* @return</span><br><span class="line">*/</span><br><span class="line">User findById(Integer userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写用户持久层映射文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.UserDao&quot;&gt;</span><br><span class="line">    &lt;!-- 根据 id 查询 --&gt;</span><br><span class="line">    &lt;select id=&quot;findById&quot; resultType=&quot;UsEr&quot; parameterType=&quot;int&quot; useCache=&quot;true&quot;&gt;</span><br><span class="line">        select * from user where id = #&#123;uid&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写测试方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testFindById() &#123;</span><br><span class="line">    //6.执行操作</span><br><span class="line">    User user = userDao.findById(41);</span><br><span class="line">    System.out.println(&quot;第一次查询的用户：&quot;+user);</span><br><span class="line">    User user2 = userDao.findById(41);</span><br><span class="line">    System.out.println(&quot;第二次查询用户：&quot;+user2);</span><br><span class="line">    System.out.println(user == user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>测试结果如下</strong>：</p>
<ul>
<li>可以发现，<strong>虽然在上面的代码中查询了两次，但最后只执行了一次数据库操作，这就是Mybatis提供的一级缓存在起作用了</strong>。因为一级缓存的存在，导致第二次查询id为41的记录时，并没有发出sql语句从数据库中查询数据，而是从一级缓存中查询。<br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/21.png" alt="image"></li>
</ul>
</li>
</ul>
<h4 id="（2）一级缓存的分析"><a href="#（2）一级缓存的分析" class="headerlink" title="（2）一级缓存的分析"></a>（2）一级缓存的分析</h4><p><strong>一级缓存是SqlSession范围的缓存，当调用SqlSession的修改，添加，删除，commit()，close()等方法时，就会清空一级缓存。</strong><br><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/22.png" alt="image"></p>
<ul>
<li>第一次发起查询用户id为1的用户信息，先去找缓存中是否有id为1的用户信息，如果没有，从数据库查询用户信息。</li>
<li>得到用户信息，将用户信息存储到一级缓存中。</li>
<li>如果sqlSession去执行commit操作（执行插入、更新、删除），清空SqlSession中的一级缓存，这样做的目的为了让缓存中存储的是最新的信息，避免脏读。</li>
<li>第二次发起查询用户id为1的用户信息，先去找缓存中是否有id为1的用户信息，缓存中有，直接从缓存<br>中获取用户信息。</li>
</ul>
<h4 id="（3）测试一级缓存的清空"><a href="#（3）测试一级缓存的清空" class="headerlink" title="（3）测试一级缓存的清空"></a>（3）测试一级缓存的清空</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 测试一级缓存</span><br><span class="line"> */</span><br><span class="line">@Test</span><br><span class="line">public void testFirstLevelCache()&#123;</span><br><span class="line">    User user1 = userDao.findById(41);</span><br><span class="line">    System.out.println(user1);</span><br><span class="line"></span><br><span class="line">//        sqlSession.close();</span><br><span class="line">//        //再次获取sqlsession对象</span><br><span class="line">//        sqlSession = factory.openSession();</span><br><span class="line">//</span><br><span class="line">    sqlSession.clearCache();//此方法也可以清空缓存</span><br><span class="line">    userDao = sqlSession.getMapper(UserDao.class);</span><br><span class="line">    User user2 = userDao.findById(41);</span><br><span class="line">    System.out.println(user2);</span><br><span class="line">    System.out.println(user1 == user2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 测试缓存的同步</span><br><span class="line"> */</span><br><span class="line">@Test</span><br><span class="line">public void testClearCache()&#123;</span><br><span class="line">    //1、根据id查询用户</span><br><span class="line">    User user1 = userDao.findById(41);</span><br><span class="line">    System.out.println(user1);</span><br><span class="line">    //2、更新用户信息</span><br><span class="line">    user1.setUsername(&quot;update user clear cache&quot;);</span><br><span class="line">    user1.setAddress(&quot;西安市周至县&quot;);</span><br><span class="line">    userDao.updateUser(user1);</span><br><span class="line">    //3、再次查询id为41的用户</span><br><span class="line">    User user2 = userDao.findById(41);</span><br><span class="line">    System.out.println(user2);</span><br><span class="line">    System.out.println(user1 == user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当执行<code>sqlSession.close()</code>后，再次获取sqlSession并查询id=41的User对象时，<strong>又重新执行了sql语句，从数据库进行了查询操作。</strong></li>
</ul>
<h3 id="2、Mybatis二级缓存"><a href="#2、Mybatis二级缓存" class="headerlink" title="2、Mybatis二级缓存"></a>2、Mybatis二级缓存</h3><p><strong>二级缓存是mapper映射级别的缓存，多个SqlSession去操作同一个Mapper映射的sql语句，多个SqlSession可以共用二级缓存，二级缓存是跨 SqlSession 的。</strong></p>
<h4 id="（1）二级缓存结构图"><a href="#（1）二级缓存结构图" class="headerlink" title="（1）二级缓存结构图"></a>（1）二级缓存结构图</h4><p><img src="/2020/03/13/初识Java持久层框架Mybatis之下（连接池、缓存和注解开发）/23.png" alt="image"></p>
<ul>
<li><strong>首先开启mybatis的二级缓存</strong>。</li>
<li><strong>sqlSession1去查询用户信息</strong>，查询到用户信息会将查询数据存储到二级缓存中。</li>
<li>如果<strong>SqlSession3去执行相同mapper映射下sql，执行commit提交</strong>，将会<strong>清空</strong>该mapper映射下的二级缓存区域的数据。</li>
<li><strong>sqlSession2去查询与sqlSession1相同的用户信息，首先会去缓存中找是否存在数据</strong>，如果<strong>存在</strong>直接从缓存中<strong>取出数据</strong>。</li>
</ul>
<h4 id="（2）二级缓存的开启与关闭"><a href="#（2）二级缓存的开启与关闭" class="headerlink" title="（2）二级缓存的开启与关闭"></a>（2）二级缓存的开启与关闭</h4><ul>
<li><strong>第一步：在SqlMapConfig.xml文件开启二级缓存</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;!-- 开启二级缓存的支持 --&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>因<strong>为cacheEnabled的取值默认就为true，所以这一步可以省略不配置</strong>。为true代表<strong>开启</strong>二级缓存；为false代表<strong>不开启</strong>二级缓存。</p>
<ul>
<li><strong>第二步：配置相关的Mapper映射文件</strong></li>
</ul>
<p><strong><code>&lt;cache&gt;</code>标签表示当前这个mapper映射将使用二级缓存，区分的标准就看mapper的namespace值。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.allen.dao.UserDao&quot;&gt;</span><br><span class="line">    &lt;!-- 开启二级缓存的支持 --&gt;</span><br><span class="line">    &lt;cache&gt;&lt;/cache&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>第三步：配置statement上面的useCache属性</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 根据 id 查询 --&gt;</span><br><span class="line">&lt;select id=&quot;findById&quot; resultType=&quot;user&quot; parameterType=&quot;int&quot; useCache=&quot;true&quot;&gt;</span><br><span class="line">    select * from user where id = #&#123;uid&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>将UserDao.xml映射文件中的<code>&lt;select&gt;</code>标签中设置<code>useCache=”true”</code>代表当前这个statement<strong>要使用二级缓存</strong>，<strong>如果不使用二级缓存可以设置为false</strong>。</p>
<ul>
<li><em>注意：针对每次查询都需要最新的数据sql，要设置成<code>useCache=false</code>，禁用二级缓存。</em></li>
</ul>
<h4 id="（3）二级缓存测试"><a href="#（3）二级缓存测试" class="headerlink" title="（3）二级缓存测试"></a>（3）二级缓存测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testFirstLevelCache()&#123;</span><br><span class="line">    SqlSession sqlSession1 = factory.openSession();</span><br><span class="line">    UserDao dao1 = sqlSession1.getMapper(UserDao.class);</span><br><span class="line">    User user1 = dao1.findById(41);</span><br><span class="line">    System.out.println(user1);</span><br><span class="line">    sqlSession1.close();//一级缓存消失</span><br><span class="line"></span><br><span class="line">    SqlSession sqlSession2 = factory.openSession();</span><br><span class="line">    UserDao dao2 = sqlSession2.getMapper(UserDao.class);</span><br><span class="line">    User user2 = dao2.findById(41);</span><br><span class="line">    System.out.println(user2);</span><br><span class="line">    sqlSession2.close();</span><br><span class="line">    System.out.println(user1 == user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>经过上面的测试，我们发现执行了两次查询，并且在执行第一次查询后，我们关闭了一级缓存，再去执行第二次查询时，我们发现并没有对数据库发出sql语句，所以此时的数据就只能是来自于我们所说的二级缓存。</strong></p>
<h4 id="（4）二级缓存注意事项"><a href="#（4）二级缓存注意事项" class="headerlink" title="（4）二级缓存注意事项"></a>（4）二级缓存注意事项</h4><p><strong>当我们在使用二级缓存时，所缓存的类一定要实现<code>java.io.Serializable</code>接口，这种就可以使用序列化方式来保存对象。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String username;</span><br><span class="line">    private Date birthday;</span><br><span class="line">    private String sex;</span><br><span class="line">    private String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="十五、Mybatis-注解开发"><a href="#十五、Mybatis-注解开发" class="headerlink" title="十五、Mybatis 注解开发"></a>十五、Mybatis 注解开发</h2><p><strong>这几年来注解开发越来越流行，Mybatis也可以使用注解开发方式，这样就可以减少编写 Mapper 映射文件了</strong>。</p>
<h3 id="1、mybatis的常用注解说明"><a href="#1、mybatis的常用注解说明" class="headerlink" title="1、mybatis的常用注解说明"></a>1、mybatis的常用注解说明</h3><pre><code>@Insert:实现新增
@Update:实现更新
@Delete:实现删除
@Select:实现查询
@Result:实现结果集封装
@Results:可以与@Result 一起使用，封装多个结果集
@ResultMap:实现引用@Results 定义的封装
@One:实现一对一结果集封装
@Many:实现一对多结果集封装
@SelectProvider: 实现动态 SQL 映射
@CacheNamespace:实现注解二级缓存的使用</code></pre><h3 id="2、使用Mybatis注解实现基本-CRUD"><a href="#2、使用Mybatis注解实现基本-CRUD" class="headerlink" title="2、使用Mybatis注解实现基本 CRUD"></a>2、使用Mybatis注解实现基本 CRUD</h3><p><strong>单表的CRUD操作是最基本的操作，所以必须掌握。</strong></p>
<h4 id="（1）编写实体类"><a href="#（1）编写实体类" class="headerlink" title="（1）编写实体类"></a>（1）编写实体类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">*  用户的实体类</span><br><span class="line">*/</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private Integer userId;</span><br><span class="line">    private String userName;</span><br><span class="line">    private Date userBirthday;</span><br><span class="line">    private String userSex;</span><br><span class="line">    private String userAddress;</span><br><span class="line">    public Integer getUserId() &#123;</span><br><span class="line">        return userId;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUserId(Integer userId) &#123;</span><br><span class="line">        this.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUserName() &#123;</span><br><span class="line">        return userName;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUserName(String userName) &#123;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">    public Date getUserBirthday() &#123;</span><br><span class="line">        return userBirthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUserBirthday(Date userBirthday) &#123;</span><br><span class="line">        this.userBirthday = userBirthday;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUserSex() &#123;</span><br><span class="line">        return userSex;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUserSex(String userSex) &#123;</span><br><span class="line">        this.userSex = userSex;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getUserAddress() &#123;</span><br><span class="line">        return userAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setUserAddress(String userAddress) &#123;</span><br><span class="line">        this.userAddress = userAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;User [userId=&quot; + userId + &quot;, userName=&quot; + userName + &quot;, userBirthday=&quot; + userBirthday + &quot;, userSex=&quot; + userSex + &quot;, userAddress=&quot; + userAddress + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：此处我们故意和数据库表的列名不一致。</strong></p>
<h4 id="（2）使用注解方式开发持久层接口"><a href="#（2）使用注解方式开发持久层接口" class="headerlink" title="（2）使用注解方式开发持久层接口"></a>（2）使用注解方式开发持久层接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 用户的持久层接口</span><br><span class="line">*/</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">    /**</span><br><span class="line">    * 查询所有用户</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Select(&quot;select * from user&quot;)</span><br><span class="line">    //对数据的封装，因为User实体类中属性和表中列名不一，如果相同，不用使用Result封装结果</span><br><span class="line">    @Results(id=&quot;userMap&quot;,</span><br><span class="line">    value= &#123;</span><br><span class="line">        @Result(id=true,column=&quot;id&quot;,property=&quot;userId&quot;),</span><br><span class="line">        @Result(column=&quot;username&quot;,property=&quot;userName&quot;),</span><br><span class="line">        @Result(column=&quot;sex&quot;,property=&quot;userSex&quot;),</span><br><span class="line">        @Result(column=&quot;address&quot;,property=&quot;userAddress&quot;),</span><br><span class="line">        @Result(column=&quot;birthday&quot;,property=&quot;userBirthday&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    List&lt;User&gt; findAll();</span><br><span class="line">    /**</span><br><span class="line">    * 根据 id 查询一个用户</span><br><span class="line">    * @param userId</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Select(&quot;select * from user where id = #&#123;uid&#125; &quot;)</span><br><span class="line">    @ResultMap(&quot;userMap&quot;)</span><br><span class="line">    User findById(Integer userId);</span><br><span class="line">    /**</span><br><span class="line">    * 保存操作</span><br><span class="line">    * @param user</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Insert(&quot;insert into user(username,sex,birthday,address)values(#&#123;username&#125;,#&#123;sex&#125;,#&#123;birthday&#125;,#&#123;address&#125; )&quot;)</span><br><span class="line">    @SelectKey(keyColumn=&quot;id&quot;,keyProperty=&quot;id&quot;,resultType=Integer.class,before = false, statement = &#123; &quot;select last_insert_id()&quot; &#125;)</span><br><span class="line">    int saveUser(User user);</span><br><span class="line">    /**</span><br><span class="line">    * 更新操作</span><br><span class="line">    * @param user</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Update(&quot;update user set username=#&#123;username&#125;,address=#&#123;address&#125;,sex=#&#123;sex&#125;,birthday=#&#123;birthday&#125; where id =#&#123;id&#125; &quot;)</span><br><span class="line">    int updateUser(User user);</span><br><span class="line">    /**</span><br><span class="line">    * 删除用户</span><br><span class="line">    * @param userId</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Delete(&quot;delete from user where id = #&#123;uid&#125; &quot;)</span><br><span class="line">    int deleteUser(Integer userId);</span><br><span class="line">    /**</span><br><span class="line">    * 查询使用聚合函数</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Select(&quot;select count(*) from user &quot;)</span><br><span class="line">    int findTotal();</span><br><span class="line">    /**</span><br><span class="line">    * 模糊查询</span><br><span class="line">    * @param name</span><br><span class="line">    * @return</span><br><span class="line">    */</span><br><span class="line">    @Select(&quot;select * from user where username like #&#123;username&#125; &quot;)</span><br><span class="line">    List&lt;User&gt; findByName(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过注解方式，我们就不需要再去编写UserDao.xml映射文件了。</strong></p>
<h4 id="（3）编写SqlMapConfig配置文件"><a href="#（3）编写SqlMapConfig配置文件" class="headerlink" title="（3）编写SqlMapConfig配置文件"></a>（3）编写SqlMapConfig配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line"> PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line"> &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- 配置 properties 文件的位置 --&gt;</span><br><span class="line">    &lt;properties resource=&quot;jdbcConfig.properties&quot;&gt;&lt;/properties&gt;</span><br><span class="line">    &lt;!-- 配置别名的注册 --&gt;</span><br><span class="line">    &lt;typeAliases&gt;</span><br><span class="line">        &lt;package name=&quot;com.allen.domain&quot;/&gt;</span><br><span class="line">    &lt;/typeAliases&gt;</span><br><span class="line">    &lt;!-- 配置环境 --&gt;</span><br><span class="line">    &lt;environments default=&quot;mysql&quot;&gt;</span><br><span class="line">        &lt;!-- 配置 mysql 的环境 --&gt;</span><br><span class="line">        &lt;environment id=&quot;mysql&quot;&gt;</span><br><span class="line">        &lt;!-- 配置事务的类型是 JDBC --&gt;</span><br><span class="line">        &lt;transactionManager type=&quot;JDBC&quot;&gt;&lt;/transactionManager&gt;</span><br><span class="line">        &lt;!-- 配置数据源 --&gt;</span><br><span class="line">        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt;</span><br><span class="line">        &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">    &lt;/environments&gt;</span><br><span class="line">    &lt;!-- 配置映射信息 --&gt;</span><br><span class="line">    &lt;mappers&gt;</span><br><span class="line">        &lt;!-- 配置 dao 接口的位置，它有两种方式</span><br><span class="line">        第一种：使用 mapper 标签配置 class 属性</span><br><span class="line">        第二种：使用 package 标签，直接指定 dao 接口所在的包</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;package name=&quot;com.allen.dao&quot;/&gt;</span><br><span class="line">    &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<h4 id="（4）编写测试方法"><a href="#（4）编写测试方法" class="headerlink" title="（4）编写测试方法"></a>（4）编写测试方法</h4><p><em>此处省略，和使用xml进行配置的一样</em></p>
<h3 id="3、使用注解实现复杂关系映射开发"><a href="#3、使用注解实现复杂关系映射开发" class="headerlink" title="3、使用注解实现复杂关系映射开发"></a>3、使用注解实现复杂关系映射开发</h3><p><strong>实现复杂关系映射之前我们可以在映射文件中通过配置<code>&lt;resultMap&gt;</code>来实现，在使用注解开发时我们需要借助<code>@Results</code>注解，<code>@Result</code>注解，<code>@One</code>注解，<code>@Many</code>注解。</strong></p>
<h4 id="（1）复杂关系映射的注解说明"><a href="#（1）复杂关系映射的注解说明" class="headerlink" title="（1）复杂关系映射的注解说明"></a>（1）复杂关系映射的注解说明</h4><ul>
<li><strong><code>@Results</code>注解</strong><ul>
<li><strong>代替的是标签<code>&lt;resultMap&gt;</code></strong></li>
<li>该注解中<strong>可以使用单个<code>@Result</code>注解，也可以使用<code>@Result</code>集合</strong></li>
<li><code>@Results({@Result()，@Result()})</code>或<code>@Results(@Result())</code></li>
</ul>
</li>
<li><strong><code>@Resutl</code>注解</strong><ul>
<li><strong>代替了<code>&lt;id&gt;</code>标签和<code>&lt;result&gt;</code>标签</strong></li>
<li><strong><code>@Result</code>中属性</strong>介绍：<ul>
<li><strong>id</strong> 主键字段</li>
<li><strong>column</strong> 数据库的列名</li>
<li><strong>property</strong> 需要装配的属性名<code>one</code>，需要使用的<code>@One</code>注解<code>(@Result(one=@One()))</code>，many需要使用的<code>@Many</code>注解 <code>(@Result(many=@many()))</code></li>
</ul>
</li>
</ul>
</li>
<li><strong><code>@One</code>注解（一对一）</strong><ul>
<li><strong>代替了<code>&lt;assocation&gt;</code>标签，是多表查询的关键，在注解中用来指定子查询返回单一对象。</strong></li>
<li><code>@One</code>注解属性介绍：<ul>
<li><strong>select</strong> <strong>指定用来多表查询的sqlmapper</strong></li>
<li><strong>fetchType</strong> 会覆盖全局的配置参数 </li>
<li><strong>lazyLoadingEnabled</strong></li>
</ul>
</li>
<li><strong>使用格式</strong>：<code>@Result(column=&quot; &quot;,property=&quot;&quot;,one=@One(select=&quot;&quot;))</code></li>
</ul>
</li>
<li><strong><code>@Many</code>注解（多对一）</strong><ul>
<li><strong>代替了<collection>标签,是是多表查询的关键</collection></strong>，在注解中用来指定子查询返回对象集合。</li>
<li><strong>注意</strong>：<strong>聚集元素用来处理“一对多”的关系</strong>。<strong>需要指定映射的Java实体类的属性，属性的javaType（一般为ArrayList）但是注解中可以不定义；</strong></li>
<li><strong>使用格式</strong>：<code>@Result(property=&quot;&quot;,column=&quot;&quot;,many=@Many(select=&quot;&quot;))</code></li>
</ul>
</li>
</ul>
<h4 id="（2）使用注解实现一对一复杂关系映射及延迟加载"><a href="#（2）使用注解实现一对一复杂关系映射及延迟加载" class="headerlink" title="（2）使用注解实现一对一复杂关系映射及延迟加载"></a>（2）使用注解实现一对一复杂关系映射及延迟加载</h4><ul>
<li><p><strong>需求</strong>：<strong>加载账户信息时并且加载该账户的用户信息，根据情况可实现延迟加载。（注解方式实现）</strong></p>
</li>
<li><p><strong>添加User实体类及Account实体类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 用户的实体类</span><br><span class="line">*/</span><br><span class="line">package com.allen.domain;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private Integer userId;</span><br><span class="line">    private String userName;</span><br><span class="line">    private String userAddress;</span><br><span class="line">    private String userSex;</span><br><span class="line">    private Date userBirthday;</span><br><span class="line"></span><br><span class="line">    public Integer getUserId() &#123;</span><br><span class="line">        return userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserId(Integer userId) &#123;</span><br><span class="line">        this.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserName() &#123;</span><br><span class="line">        return userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserName(String userName) &#123;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserAddress() &#123;</span><br><span class="line">        return userAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserAddress(String userAddress) &#123;</span><br><span class="line">        this.userAddress = userAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserSex() &#123;</span><br><span class="line">        return userSex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserSex(String userSex) &#123;</span><br><span class="line">        this.userSex = userSex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Date getUserBirthday() &#123;</span><br><span class="line">        return userBirthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserBirthday(Date userBirthday) &#123;</span><br><span class="line">        this.userBirthday = userBirthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;User&#123;&quot; +</span><br><span class="line">                &quot;userId=&quot; + userId +</span><br><span class="line">                &quot;, userName=&apos;&quot; + userName + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, userAddress=&apos;&quot; + userAddress + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, userSex=&apos;&quot; + userSex + &apos;\&apos;&apos; +</span><br><span class="line">                &quot;, userBirthday=&quot; + userBirthday +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 账户的实体类</span><br><span class="line">*/</span><br><span class="line">package com.allen.domain;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class Account &#123;</span><br><span class="line"></span><br><span class="line">    private Integer id;</span><br><span class="line">    private Integer uid;</span><br><span class="line">    private Double money;</span><br><span class="line"></span><br><span class="line">    //多对一（Mybatis中称为一对一）的映射，一个账户只能属于一个用户</span><br><span class="line">    private User user;</span><br><span class="line"></span><br><span class="line">    public User getUser() &#123;</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUser(User user) &#123;</span><br><span class="line">        this.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(Integer id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getUid() &#123;</span><br><span class="line">        return uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUid(Integer uid) &#123;</span><br><span class="line">        this.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Double getMoney() &#123;</span><br><span class="line">        return money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMoney(Double money) &#123;</span><br><span class="line">        this.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Account&#123;&quot; +</span><br><span class="line">                &quot;id=&quot; + id +</span><br><span class="line">                &quot;, uid=&quot; + uid +</span><br><span class="line">                &quot;, money=&quot; + money +</span><br><span class="line">                &apos;&#125;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>添加账户的持久层接口并使用注解配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.allen.dao;</span><br><span class="line"></span><br><span class="line">import com.allen.domain.Account;</span><br><span class="line">import org.apache.ibatis.annotations.One;</span><br><span class="line">import org.apache.ibatis.annotations.Result;</span><br><span class="line">import org.apache.ibatis.annotations.Results;</span><br><span class="line">import org.apache.ibatis.annotations.Select;</span><br><span class="line">import org.apache.ibatis.mapping.FetchType;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface AccountDao &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 查询所有账户，并且获取每个账户所属的用户信息</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Results(id=&quot;accountMap&quot;,value = &#123;</span><br><span class="line">            @Result(id = true,column = &quot;id&quot;,property = &quot;id&quot;),</span><br><span class="line">            @Result(column = &quot;uid&quot;,property = &quot;uid&quot;),</span><br><span class="line">            @Result(column = &quot;money&quot;,property = &quot;money&quot;),</span><br><span class="line">            @Result(property = &quot;user&quot;,column = &quot;uid&quot;,one=@One(select=&quot;com.allen.dao.UserDao.findById&quot;,fetchType= FetchType.EAGER))</span><br><span class="line">    &#125;)</span><br><span class="line">    @Select(&quot;select * from account&quot;)</span><br><span class="line">    List&lt;Account&gt; findAll();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据用户id查询账户信息</span><br><span class="line">     * @param userId</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;select * from account where uid=#&#123;userId&#125; &quot;)</span><br><span class="line">    List&lt;Account&gt; findAccountByUid(Integer userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>添加用户的持久层接口并使用注解配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.allen.dao;</span><br><span class="line"></span><br><span class="line">import com.allen.domain.User;</span><br><span class="line">import org.apache.ibatis.annotations.*;</span><br><span class="line">import org.apache.ibatis.mapping.FetchType;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 在mybatis中针对,CRUD一共有四个注解</span><br><span class="line"> *  * @Select @Insert @Update @Delete</span><br><span class="line"> */</span><br><span class="line">@CacheNamespace(blocking = true)</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 查询所有用户</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;select * from user &quot;)</span><br><span class="line">    @Results(id = &quot;userMap&quot;,value = &#123;</span><br><span class="line">            @Result(id=true,column = &quot;id&quot;,property = &quot;userId&quot;),</span><br><span class="line">            @Result(column = &quot;username&quot;,property = &quot;userName&quot;),</span><br><span class="line">            @Result(column = &quot;address&quot;,property = &quot;userAddress&quot;),</span><br><span class="line">            @Result(column = &quot;sex&quot;,property = &quot;userSex&quot;),</span><br><span class="line">            @Result(column = &quot;birthday&quot;,property = &quot;userBirthday&quot;),</span><br><span class="line">            @Result(property = &quot;accounts&quot; ,column = &quot;id&quot;,many = @Many(select = &quot;com.allen.dao.AccountDao.findAccountByUid&quot;,fetchType = FetchType.LAZY))</span><br><span class="line">    &#125;)</span><br><span class="line">    List&lt;User&gt; findAll();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据id查询用户</span><br><span class="line">     * @param userId</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;select * from user where id=#&#123;id&#125; &quot;)</span><br><span class="line">    @ResultMap(&quot;userMap&quot;)</span><br><span class="line">    User findById(Integer userId);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据用户名称模糊查询</span><br><span class="line">     * @param username</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;select * from user where username like #&#123;username&#125; &quot;)</span><br><span class="line">    @ResultMap(&quot;userMap&quot;)</span><br><span class="line">    List&lt;User&gt; findUserByName(String username);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>测试一对一关联及延迟加载</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 账户的测试类</span><br><span class="line">*/</span><br><span class="line">public class AccountTest &#123;</span><br><span class="line">@Test</span><br><span class="line">public void testFindAll() &#123;</span><br><span class="line">    List&lt;Account&gt; accounts = accountDao.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="（3）使用注解实现一对多复杂关系映射"><a href="#（3）使用注解实现一对多复杂关系映射" class="headerlink" title="（3）使用注解实现一对多复杂关系映射"></a>（3）使用注解实现一对多复杂关系映射</h4><ul>
<li><p><strong>需求：查询用户信息时，也要查询他的账户列表。使用注解方式实现。</strong></p>
</li>
<li><p><strong>分析：一个用户具有多个账户信息，所以形成了用户(User)与账户(Account)之间的一对多关系。</strong></p>
</li>
<li><p><strong>User 实体类加入<code>List&lt;Account&gt;</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//一对多关系映射，一个用户对应多个账户</span><br><span class="line">private List&lt;Account&gt; accounts;</span><br><span class="line"></span><br><span class="line">public List&lt;Account&gt; getAccounts() &#123;</span><br><span class="line">    return accounts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写用户的持久层接口并使用注解配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.allen.dao;</span><br><span class="line"></span><br><span class="line">import com.allen.domain.User;</span><br><span class="line">import org.apache.ibatis.annotations.*;</span><br><span class="line">import org.apache.ibatis.mapping.FetchType;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 在mybatis中针对,CRUD一共有四个注解</span><br><span class="line"> *  * @Select @Insert @Update @Delete</span><br><span class="line"> */</span><br><span class="line">@CacheNamespace(blocking = true)</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 查询所有用户</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Select(&quot;select * from user &quot;)</span><br><span class="line">    @Results(id = &quot;userMap&quot;,value = &#123;</span><br><span class="line">            @Result(id=true,column = &quot;id&quot;,property = &quot;userId&quot;),</span><br><span class="line">            @Result(column = &quot;username&quot;,property = &quot;userName&quot;),</span><br><span class="line">            @Result(column = &quot;address&quot;,property = &quot;userAddress&quot;),</span><br><span class="line">            @Result(column = &quot;sex&quot;,property = &quot;userSex&quot;),</span><br><span class="line">            @Result(column = &quot;birthday&quot;,property = &quot;userBirthday&quot;),</span><br><span class="line">            @Result(property = &quot;accounts&quot; ,column = &quot;id&quot;,many = @Many(select = &quot;com.allen.dao.AccountDao.findAccountByUid&quot;,fetchType = FetchType.LAZY))</span><br><span class="line">    &#125;)</span><br><span class="line">    List&lt;User&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>编写账户的持久层接口并使用注解配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface AccountDao &#123;</span><br><span class="line">    @Select(&quot;select * from account where uid = #&#123;uid&#125; &quot;)</span><br><span class="line">    List&lt;Account&gt; findByUid(Integer userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>添加测试方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package com.allen.test;</span><br><span class="line"></span><br><span class="line">import com.allen.dao.UserDao;</span><br><span class="line">import com.allen.domain.User;</span><br><span class="line">import org.apache.ibatis.io.Resources;</span><br><span class="line">import org.apache.ibatis.session.SqlSession;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line">import org.junit.After;</span><br><span class="line">import org.junit.Before;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class UserTest &#123;</span><br><span class="line"></span><br><span class="line">    private InputStream in;</span><br><span class="line">    private SqlSession sqlSession;</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public  void init() throws IOException &#123;</span><br><span class="line">        //1、获取字节输入流</span><br><span class="line">        in = Resources.getResourceAsStream(&quot;SqlMapConfig.xml&quot;);</span><br><span class="line">        //2、根据字节输入流构建SqlSessionFactory</span><br><span class="line">        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(in);</span><br><span class="line">        //3、根据SqlSessionFactory生产一个SqlSession</span><br><span class="line">        sqlSession = factory.openSession(true);</span><br><span class="line">        //4、使用SqlSession获取Dao的代理对象</span><br><span class="line">        userDao = sqlSession.getMapper(UserDao.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    public void destory()&#123;</span><br><span class="line">        //6、释放资源</span><br><span class="line">        if(sqlSession != null)&#123;</span><br><span class="line">            sqlSession.close();</span><br><span class="line">        &#125;</span><br><span class="line">        if (in != null)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有用户</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    public void TestFindAll()&#123;</span><br><span class="line">        //5、执行Dao的方法</span><br><span class="line">        List&lt;User&gt; users = userDao.findAll();</span><br><span class="line">        /*for (User user : users) &#123;</span><br><span class="line">            System.out.println(&quot;-----------每个用户的信息------------&quot;);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">            System.out.println(user.getAccounts());</span><br><span class="line">        &#125;*/</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="4、mybatis基于注解的二级缓存"><a href="#4、mybatis基于注解的二级缓存" class="headerlink" title="4、mybatis基于注解的二级缓存"></a>4、mybatis基于注解的二级缓存</h3><h4 id="（1）在SqlMapConfig中开启二级缓存支持"><a href="#（1）在SqlMapConfig中开启二级缓存支持" class="headerlink" title="（1）在SqlMapConfig中开启二级缓存支持"></a>（1）在SqlMapConfig中开启二级缓存支持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 配置二级缓存 --&gt;</span><br><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;!-- 开启二级缓存的支持 --&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>

<h4 id="（2）在持久层接口中使用注解配置二级缓存"><a href="#（2）在持久层接口中使用注解配置二级缓存" class="headerlink" title="（2）在持久层接口中使用注解配置二级缓存"></a>（2）在持久层接口中使用注解配置二级缓存</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@CacheNamespace(blocking=true)//mybatis基于注解方式实现配置二级缓存</span><br><span class="line">public interface UserDao &#123;</span><br><span class="line">    //各种CRUD操作的方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>历时四天，终于完成了对Mybatis的复习和巩固，这两篇Blog为证，太累了。希望大家给点鼓励，谢谢</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Allen Xue</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span><strong>To be or not to be,that is a question.<strong></strong></strong></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/Java-EE/"># Java_EE</a>
                    
                        <a href="/tag/Mybatis/"># Mybatis</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/03/12/初识Java持久层框架Mybatis之上/">初识Java持久层框架Mybatis之上</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Allen Xue | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
    
        <script type="text/javascript" color="0,0,0" opacity="0.3" zindex="-2" count="99" src="/js/canvas-nest.js"></script>
    
</body>
</html>
